<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>L+Y â€” Learn Hebrew & Albanian</title>
  <meta name="description" content="L+Y: a free Duolingoâ€‘style, singleâ€‘file app to learn basic Hebrew and Albanian. 100â€‘day course plans, XP, streaks, TTS, and optional speech recognition. Works on GitHub Pages (no backend)." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0a0f24;--panel:#11183a;--ink:#e9edff;--muted:#b6c0ff;--brand1:#70d6ff;--brand2:#a0e9ff;--accent:#8aff80;--warn:#ffd166;--bad:#ff7a7a}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;background:radial-gradient(1200px 800px at 15% 0%,#16245a,#0a0f24);color:var(--ink);-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility}
    a{color:inherit}
    #app{max-width:1180px;margin:0 auto;padding:20px}

    /* Topbar */
    .topbar{display:flex;align-items:center;gap:16px;justify-content:space-between;padding:10px 14px;background:rgba(17,24,58,.7);border:1px solid rgba(255,255,255,.06);backdrop-filter:blur(8px);border-radius:16px;position:sticky;top:10px;z-index:20}
    .brand{display:flex;align-items:center;gap:12px;font-weight:800;letter-spacing:.3px}
    .logo{width:44px;height:44px;border-radius:12px;display:grid;place-items:center;position:relative;box-shadow:0 10px 30px rgba(160,233,255,.35)}
    .logo svg{width:100%;height:100%;display:block}
    .title{line-height:1}
    .title .kicker{font-size:12px;color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:#0e1533;border:1px solid rgba(255,255,255,.08);font-size:14px}
    .stat{display:inline-flex;align-items:center;gap:8px}
    .stat .dot{width:10px;height:10px;border-radius:50%}
    .dot.xp{background:var(--accent)}
    .dot.streak{background:var(--warn)}

    .content{display:grid;grid-template-columns:320px 1fr;gap:18px;margin-top:18px}
    @media (max-width:920px){.content{grid-template-columns:1fr}}

    /* Sidebar */
    .sidebar{position:sticky;top:72px;align-self:start;display:flex;flex-direction:column;gap:14px}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:20px;padding:16px}
    .card h3{margin:0 0 8px}
    .select{display:grid;gap:10px}
    .select button{display:flex;align-items:center;gap:12px;background:#0f1840;color:var(--ink);border:1px solid rgba(255,255,255,.08);padding:12px 14px;border-radius:14px;cursor:pointer;transition:.2s transform,.2s box-shadow}
    .select button:hover{transform:translateY(-1px);box-shadow:0 10px 24px rgba(108,204,255,.15)}
    .flag{font-size:20px}

    /* Lessons map */
    .panel{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:22px;padding:18px;min-height:480px;position:relative;overflow:hidden}
    .lesson-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px}
    .skill{position:relative;background:#0e1633;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:12px;display:flex;flex-direction:column;gap:8px;min-height:110px;transition:.15s transform}
    .skill:hover{transform:translateY(-2px)}
    .skill .badge{position:absolute;top:-10px;right:-10px;background:linear-gradient(135deg,var(--brand1),var(--brand2));color:#013;font-weight:800;padding:6px 10px;border-radius:999px;box-shadow:0 10px 20px rgba(108,204,255,.35)}
    .skill h4{margin:0;font-size:15px}
    .skill .meta{color:var(--muted);font-size:12px}
    .skill button{margin-top:auto;background:linear-gradient(135deg,var(--brand1),#b7f3ff);color:#012;border:0;padding:8px 10px;border-radius:10px;cursor:pointer;font-weight:700}

    /* Exercise modal */
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(3,7,18,.6);backdrop-filter:blur(8px);z-index:50}
    .modal.open{display:grid}
    .sheet{width:min(880px,96vw);background:linear-gradient(180deg,#111a3a,#0d1531);border:1px solid rgba(255,255,255,.08);border-radius:22px;padding:20px;box-shadow:0 30px 80px rgba(0,0,0,.45)}
    .sheet header{display:flex;justify-content:space-between;align-items:center}
    .sheet h3{margin:0}
    .close{background:#0e1633;border:1px solid rgba(255,255,255,.1);color:var(--ink);border-radius:12px;padding:8px 10px;cursor:pointer}
    .q{margin-top:14px;background:#0f1840;border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:16px}
    .answers{display:grid;gap:10px;margin-top:12px}
    .answers button{background:#0f1840;border:1px solid rgba(255,255,255,.08);color:var(--ink);padding:12px;border-radius:14px;text-align:left;cursor:pointer}
    .answers button.correct{outline:2px solid var(--accent)}
    .answers button.incorrect{outline:2px solid var(--bad)}
    .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:16px}
    .primary{background:linear-gradient(135deg,var(--accent),#b6ffb0);color:#061a06;border:0;padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer}
    .ghost{background:#0e1633;border:1px solid rgba(255,255,255,.1);color:var(--ink);border-radius:12px;padding:10px 14px;cursor:pointer}

    /* Toast & confetti */
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#0e1633;border:1px solid rgba(255,255,255,.1);padding:10px 14px;border-radius:12px;display:none;z-index:70}
    .toast.show{display:block;animation:pop .2s ease}
    @keyframes pop{from{transform:translate(-50%,10px);opacity:0}to{transform:translate(-50%,0);opacity:1}}
    .confetti{position:fixed;inset:0;pointer-events:none;overflow:hidden}
    .piece{position:absolute;width:8px;height:14px;opacity:0;animation:fall 1.2s ease-out forwards}
    @keyframes fall{0%{transform:translateY(-20px) rotate(0deg);opacity:0}10%{opacity:1}100%{transform:translateY(110vh) rotate(540deg);opacity:0}}

    .small{font-size:12px;color:var(--muted)} .muted{color:var(--muted)} .row{display:flex;align-items:center;gap:10px} .space{flex:1} .hidden{display:none!important}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <div id="app">
    <div class="topbar">
      <div class="brand">
        <!-- Improved logo -->
        <div class="logo" aria-hidden="true" title="L+Y">
          <svg viewBox="0 0 100 100" role="img" aria-label="L plus Y logo">
            <defs>
              <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="var(--brand1)"/>
                <stop offset="100%" stop-color="var(--brand2)"/>
              </linearGradient>
              <linearGradient id="glass" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="#ffffff" stop-opacity=".7"/>
                <stop offset="100%" stop-color="#ffffff" stop-opacity=".05"/>
              </linearGradient>
              <filter id="blur"><feGaussianBlur stdDeviation="1.2"/></filter>
            </defs>
            <rect x="8" y="8" width="84" height="84" rx="18" fill="url(#g1)"/>
            <rect x="8" y="8" width="84" height="84" rx="18" fill="url(#glass)"/>
            <g fill="#001529" font-family="Inter, system-ui" font-weight="800" font-size="42" text-anchor="middle">
              <text x="38" y="60">L</text>
              <text x="50" y="56" font-size="22">ï¼‹</text>
              <text x="68" y="60">Y</text>
            </g>
            <circle cx="84" cy="20" r="6" fill="#fff" opacity=".7" filter="url(#blur)"/>
          </svg>
        </div>
        <div class="title">
          <div>L+Y</div>
          <div class="kicker">Hebrew & Albanian â€¢ 100â€‘day plans</div>
        </div>
      </div>
      <div class="row">
        <div class="pill stat" title="XP"><span class="dot xp"></span><span id="xp">0</span> XP</div>
        <div class="pill stat" title="Daily Streak"><span class="dot streak"></span><span id="streak">0</span> ğŸ”¥</div>
        <button class="pill" id="profileBtn" title="Profile & settings">âš™ï¸ Settings</button>
      </div>
    </div>

    <div class="content">
      <aside class="sidebar">
        <div class="card">
          <h3>Choose a course</h3>
          <div class="select">
            <button data-lang="he" aria-label="Hebrew course"><span class="flag">ğŸ‡®ğŸ‡±</span><div><div><strong>Hebrew</strong> <span class="small">(×¢×‘×¨×™×ª)</span></div><div class="small">100 days â€¢ letters, phrases, travel</div></div><span class="space"></span><span class="small" id="progress-he">0%</span></button>
            <button data-lang="sq" aria-label="Albanian course"><span class="flag">ğŸ‡¦ğŸ‡±</span><div><div><strong>Albanian</strong> <span class="small">(Shqip)</span></div><div class="small">100 days â€¢ basics, numbers, phrases</div></div><span class="space"></span><span class="small" id="progress-sq">0%</span></button>
          </div>
        </div>
        <div class="card">
          <h3>Daily Goal</h3>
          <div class="row">
            <button class="pill" data-goal="10">ğŸ¥‰ Casual (10 XP)</button>
            <button class="pill" data-goal="30">ğŸ¥ˆ Regular (30 XP)</button>
            <button class="pill" data-goal="50">ğŸ¥‡ Intense (50 XP)</button>
          </div>
          <div class="small" id="goalText" style="margin-top:8px">Goal: 10 XP/day</div>
        </div>
        <div class="card">
          <h3>Audio</h3>
          <div class="row"><button class="pill" id="voiceTest">ğŸ”Š Test voice</button><button class="pill" id="micTest">ğŸ¤ Test mic</button></div>
          <div class="small muted" id="audioStatus" style="margin-top:8px">Web Speech API for TTS/STT (falls back gracefully if unavailable).</div>
        </div>
        <div class="card">
          <h3>Profile & Backup</h3>
          <div class="row"><button class="pill" id="exportBtn">â¬‡ï¸ Export</button><button class="pill" id="importBtn">â¬†ï¸ Import</button><button class="pill" id="resetBtn">ğŸ—‘ï¸ Reset</button></div>
          <div class="small" id="deviceInfo" style="margin-top:8px"></div>
        </div>
      </aside>

      <main>
        <div class="panel">
          <h2 style="margin:0 0 8px">Course Map â€” <span id="courseTitle">Select a course</span></h2>
          <div class="lesson-grid" id="grid" aria-live="polite"></div>
        </div>
        <div class="small muted" style="margin-top:8px">Progress, XP, and streak are saved in your browser (local). Export/Import to move between devices.</div>
      </main>
    </div>
  </div>

  <!-- Modal: Exercise Player -->
  <div class="modal" id="modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="sheet" role="document">
      <header>
        <h3 id="exerciseTitle">Exercise</h3>
        <div class="row"><div class="pill small" id="lives">â¤ï¸â¤ï¸â¤ï¸</div><button class="close" id="close">Esc</button></div>
      </header>
      <div class="q" id="question">Loadingâ€¦</div>
      <div class="answers" id="answers"></div>
      <div class="actions"><button class="ghost" id="playAudio">ğŸ”Š Play</button><button class="ghost" id="speakBtn">ğŸ¤ Speak</button><button class="primary" id="next">Next âœ</button></div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>
  <div class="confetti" id="confetti" aria-hidden="true"></div>

  <script>
  /****************************
   *   L+Y â€” core logic v2   *
   ****************************/

  // â€”â€”â€” utilities
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const clamp = (n,min,max)=> Math.max(min, Math.min(max, n));

  // Deterministic PRNG for reproducible daily sets
  function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296}}
  function seededShuffle(arr, seed){const r=mulberry32(seed);const a=[...arr];for(let i=a.length-1;i>0;i--){const j=Math.floor(r()* (i+1));[a[i],a[j]]=[a[j],a[i]]}return a}

  // Normalize (serverless, no Unicode escape usage in source)
  function stripDiacritics(s){
    const map = {'Ã«':'e','Ã‹':'e','Ã§':'c','Ã‡':'c','Ã¡':'a','Ã ':'a','Ã¤':'a','Ã©':'e','Ã¨':'e','Ãª':'e','Ã­':'i','Ã¬':'i','Ã¯':'i','Ã³':'o','Ã²':'o','Ã¶':'o','Ãº':'u','Ã¹':'u','Ã¼':'u'};
    return s.replace(/[Ã«Ã‹Ã§Ã‡Ã¡Ã Ã¤Ã©Ã¨ÃªÃ­Ã¬Ã¯Ã³Ã²Ã¶ÃºÃ¹Ã¼]/g, ch => map[ch] || ch);
  }
  function norm(s){
    return stripDiacritics((s||'').toString().trim().toLowerCase()).replace(/ +/g,' ');
  }

  // Timezoneâ€‘aware date key (no server clock)
  function tzLocalDateKey(){
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
    const now = new Date();
    const fmt = new Intl.DateTimeFormat('en-CA',{timeZone:tz, year:'numeric', month:'2-digit', day:'2-digit'});
    const parts = fmt.formatToParts(now);
    const y = parts.find(p=>p.type==='year').value;
    const m = parts.find(p=>p.type==='month').value;
    const d = parts.find(p=>p.type==='day').value;
    return `${y}-${m}-${d}`;
  }

  // Lightweight device fingerprint (not IP â€” serverless)
  function deviceId(){
    const s = [navigator.userAgent, screen.width, screen.height, Intl.DateTimeFormat().resolvedOptions().timeZone].join('|');
    let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0}return 'LY-'+Math.abs(h).toString(36)
  }

  // Confetti + toast
  const toastEl = $('#toast');
  function toast(msg){ toastEl.textContent = msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'), 1800) }
  const confettiEl = $('#confetti');
  function confetti(){ for(let i=0;i<80;i++){ const p=document.createElement('div'); p.className='piece'; p.style.left=Math.random()*100+'vw'; p.style.top='-10px'; p.style.background=['#8aff80','#70d6ff','#ffd166','#ff7a7a'][i%4]; p.style.animationDelay=(Math.random()*0.6)+'s'; confettiEl.appendChild(p); setTimeout(()=>p.remove(),1500) } }

  // Persistence
  const store = {
    get(){ return JSON.parse(localStorage.getItem('ly-data')||'{}') },
    set(d){ localStorage.setItem('ly-data', JSON.stringify(d)) },
    patch(p){ const d={...store.get(),...p}; store.set(d); return d }
  }

  let state = { lang:null, xp:0, streak:0, lastActiveKey:null, goal:10, progress:{}, lives:3, device:deviceId() };
  function load(){ state = {...state, ...store.get()}; updateTopbar(); updateProgressPills(); $('#deviceInfo').textContent = `Device: ${state.device}` }
  function save(){ store.set(state) }

  // Courses generated from vocab pools (100 days each)
  const HE_VOCAB = [
    {t:'×©×œ×•×', e:'hello'},{t:'×ª×•×“×”', e:'thank you'},{t:'×‘×‘×§×©×”', e:'please'},{t:'×¡×œ×™×—×”', e:'sorry'},{t:'×›×Ÿ', e:'yes'},{t:'×œ×', e:'no'},{t:'×‘×•×§×¨ ×˜×•×‘', e:'good morning'},{t:'×œ×™×œ×” ×˜×•×‘', e:'good night'},{t:'××” × ×©××¢?', e:'how are you?'},{t:'×˜×•×‘', e:'good'},{t:'×¨×¢', e:'bad'},{t:'××•×›×œ', e:'food'},{t:'××™×', e:'water'},{t:'×œ×—×', e:'bread'},{t:'×§×¤×”', e:'coffee'},{t:'×ª×”', e:'tea'},{t:'×—×œ×‘', e:'milk'},{t:'×™×™×Ÿ', e:'wine'},{t:'×‘×™×¨×”', e:'beer'},{t:'×ª×¤×•×—', e:'apple'},{t:'×‘× × ×”', e:'banana'},{t:'×¢×•×£', e:'chicken'},{t:'×‘×§×¨', e:'beef'},{t:'×“×’', e:'fish'},{t:'×™×¨×§×•×ª', e:'vegetables'},{t:'×¤×¨×™', e:'fruit'},{t:'×‘×™×ª', e:'home'},{t:'××œ×•×Ÿ', e:'hotel'},{t:'××¡×¢×“×”', e:'restaurant'},{t:'×ª×—× ×ª ×¨×›×‘×ª', e:'train station'},{t:'×ª×—× ×”', e:'station'},{t:'×©×“×” ×ª×¢×•×¤×”', e:'airport'},{t:'××•×˜×•×‘×•×¡', e:'bus'},{t:'××•× ×™×ª', e:'taxi'},{t:'×›×¨×˜×™×¡', e:'ticket'},{t:'×©×™×¨×•×ª×™×', e:'bathroom'},{t:'×™××™×Ÿ', e:'right'},{t:'×©×××œ', e:'left'},{t:'××™×¤×”', e:'where'},{t:'××ª×™', e:'when'},{t:'×›××”', e:'how much'},{t:'××”', e:'what'},{t:'××™', e:'who'},{t:'×× ×™', e:'I'},{t:'××ª×”', e:'you (m.)'},{t:'××ª', e:'you (f.)'},{t:'×”×•×', e:'he'},{t:'×”×™×', e:'she'},{t:'×× ×—× ×•', e:'we'},{t:'×”×', e:'they'},{t:'×¨×•×¦×”', e:'want'},{t:'×¦×¨×™×š', e:'need'},{t:'×™×© ×œ×™', e:'I have'},{t:'××™×Ÿ ×œ×™', e:"I don't have"},{t:'×× ×™ ××‘×™×Ÿ', e:'I understand (m.)'},{t:'×× ×™ ×œ× ××‘×™×Ÿ', e:"I don't understand (m.)"},{t:'×¢×–×¨×”', e:'help'},{t:'×¨×•×¤×', e:'doctor'},{t:'××©×˜×¨×”', e:'police'},{t:'×—× ×•×ª', e:'shop'},{t:'×¨×—×•×‘', e:'street'},{t:'×¢×™×¨', e:'city'},{t:'×›×¡×£', e:'money'},{t:'×–××Ÿ', e:'time'},{t:'×™×•×', e:'day'},{t:'×œ×™×œ×”', e:'night'},{t:'×”×™×•×', e:'today'},{t:'××—×¨', e:'tomorrow'},{t:'××ª××•×œ', e:'yesterday'},{t:'×¤×ª×•×—', e:'open'},{t:'×¡×’×•×¨', e:'closed'},{t:'×—×', e:'hot'},{t:'×§×¨', e:'cold'},{t:'×™×¤×”', e:'beautiful'},{t:'×˜×¢×™×', e:'tasty'},{t:'×’×“×•×œ', e:'big'},{t:'×§×˜×Ÿ', e:'small'},{t:'×œ××˜', e:'slow'},{t:'××”×¨', e:'fast'},{t:'× ×¡×™×¢×”', e:'trip'},{t:'×›×™×•×•×Ÿ', e:'direction'},{t:'×›×¨×˜×™×¡ ××©×¨××™', e:'credit card'},{t:'×—×©×‘×•×Ÿ', e:'bill'},{t:'×™×', e:'sea'},{t:'×—×•×£', e:'beach'}
  ];

  const SQ_VOCAB = [
    {t:'pÃ«rshÃ«ndetje', e:'hello'},{t:'faleminderit', e:'thank you'},{t:'ju lutem', e:'please'},{t:'mÃ« falni', e:'sorry'},{t:'po', e:'yes'},{t:'jo', e:'no'},{t:'mirÃ«mÃ«ngjes', e:'good morning'},{t:'natÃ« e mirÃ«', e:'good night'},{t:'si je?', e:'how are you?'},{t:'mirÃ«', e:'good'},{t:'keq', e:'bad'},{t:'ushqim', e:'food'},{t:'ujÃ«', e:'water'},{t:'bukÃ«', e:'bread'},{t:'kafe', e:'coffee'},{t:'Ã§aj', e:'tea'},{t:'qumÃ«sht', e:'milk'},{t:'verÃ«', e:'wine'},{t:'birrÃ«', e:'beer'},{t:'mollÃ«', e:'apple'},{t:'banane', e:'banana'},{t:'pulÃ«', e:'chicken'},{t:'mish viÃ§i', e:'beef'},{t:'peshk', e:'fish'},{t:'perime', e:'vegetables'},{t:'frut', e:'fruit'},{t:'shtÃ«pi', e:'home'},{t:'hotel', e:'hotel'},{t:'restorant', e:'restaurant'},{t:'stacioni i trenit', e:'train station'},{t:'stacion', e:'station'},{t:'aeroport', e:'airport'},{t:'autobus', e:'bus'},{t:'taksi', e:'taxi'},{t:'biletÃ«', e:'ticket'},{t:'banjÃ«', e:'bathroom'},{t:'djathtas', e:'right'},{t:'majtas', e:'left'},{t:'ku', e:'where'},{t:'kur', e:'when'},{t:'sa', e:'how much'},{t:'Ã§farÃ«', e:'what'},{t:'kush', e:'who'},{t:'unÃ«', e:'I'},{t:'ti', e:'you'},{t:'ai', e:'he'},{t:'ajo', e:'she'},{t:'ne', e:'we'},{t:'ata', e:'they'},{t:'dua', e:'want'},{t:'duhet', e:'need'},{t:'kam', e:'I have'},{t:'nuk kam', e:"I don't have"},{t:'kuptoj', e:'I understand'},{t:'nuk kuptoj', e:"I don't understand"},{t:'ndihmÃ«', e:'help'},{t:'mjek', e:'doctor'},{t:'policia', e:'police'},{t:'dyqan', e:'shop'},{t:'rrugÃ«', e:'street'},{t:'qytet', e:'city'},{t:'para', e:'money'},{t:'kohÃ«', e:'time'},{t:'ditÃ«', e:'day'},{t:'natÃ«', e:'night'},{t:'sot', e:'today'},{t:'nesÃ«r', e:'tomorrow'},{t:'dje', e:'yesterday'},{t:'hapur', e:'open'},{t:'mbyllur', e:'closed'},{t:'nxehtÃ«', e:'hot'},{t:'ftohtÃ«', e:'cold'},{t:'bukur', e:'beautiful'},{t:'i shijshÃ«m', e:'tasty'},{t:'i madh', e:'big'},{t:'i vogÃ«l', e:'small'},{t:'ngadalÃ«', e:'slow'},{t:'shpejt', e:'fast'},{t:'udhÃ«tim', e:'trip'},{t:'drejtim', e:'direction'},{t:'kartÃ« krediti', e:'credit card'},{t:'faturÃ«', e:'bill'},{t:'det', e:'sea'},{t:'plazh', e:'beach'}
  ];

  function buildCourse(lang){
    const pool = lang==='he'? HE_VOCAB : SQ_VOCAB;
    const label = lang==='he'? 'Hebrew (×¢×‘×¨×™×ª)' : 'Albanian (Shqip)';
    const code = lang==='he'? 'he-IL' : 'sq-AL';
    const skills = [];
    for(let day=1; day<=100; day++){
      skills.push({ id:`${lang}-day-${day}`, name:`Day ${day}`, badge: day%10===0? 'â­':'ğŸ“˜', lessons: makeDayLessons(pool, lang, code, day) });
    }
    return { name:label, code, from:'English', skills };
  }

  function pickN(pool, n, seed){
    const shuffled = seededShuffle(pool, seed);
    return shuffled.slice(0, n);
  }

  function makeDistractors(pool, correct, n, seed){
    const others = pool.filter(x=>x!==correct);
    return seededShuffle(others, seed).slice(0, n).map(x=> x.e);
  }

  function makeDayLessons(pool, lang, code, day){
    const seedBase = (lang==='he'? 101 : 202) + day*73;
    const items = pickN(pool, 4, seedBase);
    const L = [];
    // 1) Multiple choice: target -> English
    L.push({ type:'mc', prompt:`Choose the meaning of: <strong>${items[0].t}</strong>`, choices: seededShuffle([items[0].e, ...makeDistractors(pool, items[0], 3, seedBase+1)], seedBase+2), answer: items[0].e });
    // 2) Type English -> target
    L.push({ type:'type', prompt:`Type in ${lang==='he'?'Hebrew':'Albanian'}: <em>${items[1].e}</em>`, answer: items[1].t, dir: lang==='he'? 'rtl':'ltr' });
    // 3) TTS: play target, user picks English
    L.push({ type:'tts', prompt:'Listen & choose the meaning', tts: items[2].t, choices: seededShuffle([items[2].e, ...makeDistractors(pool, items[2], 3, seedBase+3)], seedBase+4), answer: items[2].e });
    // 4) Type target -> English
    L.push({ type:'type', prompt:`Translate to English: <strong>${items[3].t}</strong>`, answer: items[3].e });
    // 5) Speak every 5th day (optional)
    if(day % 5 === 0){ L.push({ type:'speak', prompt:`Say: ${items[0].t}`, answer: items[0].t }); }
    return L;
  }

  // Runtime course registry (generated on demand)
  const COURSES = { he: buildCourse('he'), sq: buildCourse('sq') };

  // UI rendering
  const grid = $('#grid'); const courseTitle = $('#courseTitle');
  function renderCourse(){
    grid.innerHTML='';
    if(!state.lang){ courseTitle.textContent='Select a course'; return }
    const course = COURSES[state.lang];
    courseTitle.textContent = course.name;
    course.skills.forEach((skill,i)=>{
      const div = document.createElement('div');
      div.className='skill';
      div.innerHTML = `<div class="badge">${skill.badge}</div><h4>${i+1}. ${skill.name}</h4><div class="meta">${skill.lessons.length} exercises</div><button data-skill="${skill.id}">${state.progress[skill.id]?.completed? 'Review' : 'Start âœ'}</button>`;
      if(state.progress[skill.id]?.completed){ const done=document.createElement('div'); done.className='small'; done.style.cssText='position:absolute;bottom:10px;right:12px;color:var(--accent);font-weight:800'; done.textContent='âœ“ Complete'; div.appendChild(done) }
      grid.appendChild(div);
    })
  }

  function updateTopbar(){ $('#xp').textContent = state.xp|0; $('#streak').textContent = state.streak|0 }
  function updateProgressPills(){
    const pct = (lang)=>{ const c=COURSES[lang]; const total=c.skills.length; const done=c.skills.filter(s=>state.progress[s.id]?.completed).length; return Math.round((done/total)*100) };
    $('#progress-he').textContent = pct('he')+'%'; $('#progress-sq').textContent = pct('sq')+'%'
  }

  // Streak logic (timezoneâ€‘aware; serverless)
  function touchStreak(){
    const key = tzLocalDateKey();
    if(state.lastActiveKey===key){ /* same day */ }
    else if(!state.lastActiveKey){ state.streak=1 }
    else{
      const last = new Date(state.lastActiveKey+'T00:00:00');
      const curr = new Date(key+'T00:00:00');
      const diff = Math.round((curr-last)/86400000);
      if(diff===1) state.streak += 1; else if(diff>1) state.streak = 1;
    }
    state.lastActiveKey = key;
  }

  // Exercise engine
  let queue=[]; let skillId=null; let index=0; let currentLangCode='en-US';
  const modal = $('#modal'); const qEl = $('#question'); const aEl = $('#answers'); const titleEl = $('#exerciseTitle'); const livesEl = $('#lives');

  const tts = {
    speak(text, lang){ if(!('speechSynthesis' in window)){ toast('ğŸ”‡ TTS not supported'); return } const u=new SpeechSynthesisUtterance(text); u.lang=lang||'en-US'; const voices=speechSynthesis.getVoices(); const v=voices.find(v=>v.lang.toLowerCase().startsWith((lang||'en-US').toLowerCase())); if(v) u.voice=v; speechSynthesis.cancel(); speechSynthesis.speak(u) }
  }
  function canSTT(){ return ('webkitSpeechRecognition' in window) || ('SpeechRecognition' in window) }
  function initSTT(){ const Cls=window.SpeechRecognition||window.webkitSpeechRecognition; if(!Cls) return null; const r=new Cls(); r.continuous=false; r.interimResults=false; r.lang=currentLangCode; return r }
  let recognizer=null;

  function startSkill(id){
    const course = COURSES[state.lang]; const skill = course.skills.find(s=>s.id===id); if(!skill) return;
    skillId=id; queue=[...skill.lessons]; index=0; state.lives=3; updateLives(); currentLangCode=course.code; titleEl.textContent = `${skill.name} (${course.name})`; modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; recognizer=initSTT(); nextExercise();
  }
  function updateLives(){ livesEl.textContent = 'â¤ï¸'.repeat(state.lives)+' '+ 'â™¡'.repeat(3-state.lives) }
  function endSkill(win){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); document.body.style.overflow='auto'; if(win){ state.xp += 10; touchStreak(); state.progress[skillId]={completed:true,crowns:1}; confetti(); toast('â­ Skill complete! +10 XP'); updateTopbar(); updateProgressPills(); renderCourse(); save() } else { toast('ğŸ’” Out of lives. Try again!') } }

  function nextExercise(){ if(index>=queue.length) return endSkill(true); const ex=queue[index]; aEl.innerHTML=''; qEl.innerHTML = ex.prompt; $('#playAudio').classList.toggle('hidden', !('tts' in ex)); $('#speakBtn').classList.toggle('hidden', ex.type!=='speak');
    if(ex.dir){ qEl.setAttribute('dir', ex.dir) } else { qEl.removeAttribute('dir') }
    if(ex.type==='mc' || ex.type==='tts'){ const choices=[...(ex.choices||[])]; choices.forEach(c=>{ const b=document.createElement('button'); b.textContent=c; b.onclick=()=>grade(norm(c)===norm(ex.answer), b); aEl.appendChild(b) }) }
    if(ex.type==='type' || ex.type==='tts'){ const input=document.createElement('input'); input.placeholder='Type your answerâ€¦'; input.style.cssText='padding:12px;width:100%;border-radius:12px;background:#0f1840;border:1px solid rgba(255,255,255,.12);color:var(--ink)'; if(ex.dir) input.setAttribute('dir',ex.dir); aEl.appendChild(input) }
    if(ex.type==='speak'){ const hint=document.createElement('div'); hint.className='small muted'; hint.textContent = "Click ğŸ¤ Speak, say the phrase, we'll autoâ€‘check."; aEl.appendChild(hint) }
    if(ex.tts){ tts.speak(ex.tts, currentLangCode) }
  }

  function grade(correct, btn){ if(btn){ btn.classList.add(correct?'correct':'incorrect') } if(correct){ toast('âœ… Correct'); index++; setTimeout(nextExercise, 320) } else { toast('âŒ Try again'); state.lives--; updateLives(); if(state.lives<=0) endSkill(false) } }

  // Events
  document.addEventListener('click', (e)=>{
    const t=e.target;
    if(t.matches('.select button[data-lang]')){ state.lang=t.getAttribute('data-lang'); save(); renderCourse() }
    if(t.matches('.skill button[data-skill]')) startSkill(t.getAttribute('data-skill'));
    if(t.matches('#close')) endSkill(false);
    if(t.matches('#next')){
      const ex=queue[index]; if(ex){ if(ex.type==='type' || ex.type==='tts'){ const val=aEl.querySelector('input')?.value||''; const ans=ex.answer||''; grade(norm(val)===norm(ans)) } else if(ex.type==='mc'){ toast('Pick an option') } else if(ex.type==='speak'){ toast('Use ğŸ¤ Speak to answer') } }
    }
    if(t.matches('#playAudio')){ const ex=queue[index]; if(ex?.tts) tts.speak(ex.tts, currentLangCode) }
    if(t.matches('#speakBtn')){
      if(!canSTT()) return toast('ğŸ¤ Speech recognition not supported here');
      const ex=queue[index]; if(ex.type!=='speak') return; try{ recognizer=initSTT(); recognizer.onresult=(ev)=>{ const said=ev.results[0][0].transcript; grade(norm(said)===norm(ex.answer)) }; recognizer.onerror=()=> toast('Mic error. Try again.'); recognizer.start(); toast('Listeningâ€¦') }catch(err){ toast('Mic blocked. Allow microphone and retry.') }
    }
    if(t.matches('[data-goal]')){ state.goal=Number(t.getAttribute('data-goal')); save(); $('#goalText').textContent=`Goal: ${state.goal} XP/day`; toast('Goal updated') }
    if(t.matches('#voiceTest')){ tts.speak('Welcome to L plus Y!', 'en-US') }
    if(t.matches('#micTest')){ toast(canSTT()? 'ğŸ¤ Mic available' : 'ğŸ¤ Not supported in this browser') }
    if(t.matches('#exportBtn')){ const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='ly-save.json'; a.click(); URL.revokeObjectURL(url); toast('Save exported') }
    if(t.matches('#importBtn')){ const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json'; inp.onchange=(ev)=>{ const f=ev.target.files[0]; if(!f) return; const reader=new FileReader(); reader.onload=()=>{ try{ const data=JSON.parse(reader.result); state={...state,...data}; save(); load(); renderCourse(); toast('Save imported') }catch{ toast('Invalid file') } }; reader.readAsText(f) }; inp.click() }
    if(t.matches('#resetBtn')){ if(confirm('Reset all progress?')){ localStorage.removeItem('ly-data'); state={lang:null,xp:0,streak:0,lastActiveKey:null,goal:10,progress:{},lives:3,device:deviceId()}; load(); renderCourse(); toast('Progress reset') } }
  })

  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && $('#modal').classList.contains('open')) endSkill(false); if(e.key==='Enter' && $('#modal').classList.contains('open')) $('#next').click() })

  function firstVoiceWarm(){ if('speechSynthesis' in window){ setTimeout(()=> window.speechSynthesis.getVoices(), 100) } }

  function init(){ load(); renderCourse(); firstVoiceWarm() }
  init();
  </script>
</body>
</html>
